<!DOCTYPE html>
<html>
<head>
    <title>Version System Test</title>
</head>
<body>
    <h1>PWA Version System Test</h1>
    <div id="status"></div>
    <button onclick="testVersionChange()">Test Version Change</button>
    <button onclick="checkCurrentVersion()">Check Current Version</button>
    <button onclick="checkAppVersion()">Check App Version</button>
    <button onclick="forceUpdate()">Force Service Worker Update</button>
    <button onclick="clearData()">Clear All Data</button>

    <script>
        const statusDiv = document.getElementById('status');

        function log(message) {
            statusDiv.innerHTML += '<p>' + new Date().toLocaleTimeString() + ': ' + message + '</p>';
            console.log(message);
        }

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                    log('Service Worker registered successfully');
                })
                .catch(error => {
                    log('Service Worker registration failed: ' + error);
                });
        }

        async function checkCurrentVersion() {
            try {
                const request = indexedDB.open('__version_check__', 1);
                
                request.onsuccess = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('version')) {
                        log('No version stored yet');
                        db.close();
                        return;
                    }
                    
                    const transaction = db.transaction(['version'], 'readonly');
                    const store = transaction.objectStore('version');
                    const getRequest = store.get('prep_tracker_version');
                    
                    getRequest.onsuccess = () => {
                        const result = getRequest.result;
                        if (result) {
                            log('Stored version: ' + result.version + ' (timestamp: ' + result.timestamp + ')');
                        } else {
                            log('No version data found');
                        }
                        db.close();
                    };
                };
                
                request.onerror = () => {
                    log('Failed to check version');
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('version')) {
                        db.createObjectStore('version', { keyPath: 'key' });
                    }
                };
            } catch (error) {
                log('Error checking version: ' + error.message);
            }
        }

        async function testVersionChange() {
            log('Testing version change by updating service worker...');
            
            // Force update the service worker
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration('/sw.js');
                if (registration) {
                    await registration.update();
                    log('Service worker update triggered');
                } else {
                    log('No service worker registration found');
                }
            }
        }

        async function clearData() {
            try {
                // Clear version database
                const deleteRequest = indexedDB.deleteDatabase('__version_check__');
                deleteRequest.onsuccess = () => {
                    log('Version database cleared');
                };
                
                // Clear main database
                const deleteMainRequest = indexedDB.deleteDatabase('PREPTracker');
                deleteMainRequest.onsuccess = () => {
                    log('Main database cleared');
                };
                
                log('Clearing all data...');
            } catch (error) {
                log('Error clearing data: ' + error.message);
            }
        }

        function checkAppVersion() {
            const appVersion = localStorage.getItem('app_version');
            log('Stored app version: ' + (appVersion || 'Not set'));
        }

        async function forceUpdate() {
            if ('serviceWorker' in navigator) {
                const registration = await navigator.serviceWorker.getRegistration('/sw.js');
                if (registration) {
                    log('Forcing service worker update...');
                    await registration.update();
                    log('Service worker update triggered');
                } else {
                    log('No service worker registration found');
                }
            }
        }

        // Initial checks
        setTimeout(() => {
            checkCurrentVersion();
            checkAppVersion();
        }, 1000);
    </script>
</body>
</html>